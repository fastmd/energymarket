<% provide(:title, 'Точки учета') %>

<% if @fpr > 5 then @flr = @cp.furnizor else @flr = @cp.filial end %>
	           
<nav class="navbar">
  <ul class="nav nav-pills pull-left">
    <li><%= link_to "Назад", companies_path(@flr), :class => "glyphicon glyphicon-level-up" %></li>
  </ul>  
</nav>

<ul class="breadcrumb">
  <li><%= if (@fpr > 5) 
  	         then link_to "Поставщики", welcome_index_path, :class => "glyphicon glyphicon-home"
  	         else link_to "Филиалы", welcome_index_path, :class => "glyphicon glyphicon-home" end %></li>	
  <li><%= if (@fpr > 5) 
  	         then link_to "Поставщик: #{@cp.furnizor.name}", companies_path(:id => @cp.furnizor_id), :class => "glyphicon glyphicon-piggy-bank"
  	         else link_to "Филиал: #{@cp.filial.name}", companies_path(:id => @cp.filial_id), :class => "glyphicon glyphicon-tower" end %></li>
  <li class="active"><span class="glyphicon glyphicon-lamp" aria-hidden="true"></span><strong><%= "Потребитель: #{@cp.name}" %></strong></li>
</ul>

<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingOne">
      <h4 class="panel-title">
        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne" class = "glyphicon glyphicon-wrench">
          <% if @flag=='edit' then %>Редактировать точку учета<% else %>Добавить точку учета<% end %>          
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse <%= if (@flag!='edit' && @flag!='add') then "collapse" end %>" role="tabpanel" aria-labelledby="headingOne">	
      <div class="panel-body">
		<h3 align="center"><% if @flag=='edit' then %>Редактирование точки учета<% else %>Ввод новой точки учета<% end %></h3>
		<%= form_for(@mpoint) do |f| %>
			<table class="table table-striped">
				<thead>
					<tr>
						<th>Наименование</th>
		   				<th>Подстанция подключения ME</th>
		   				<th>Наименование фидера ME</th>
		   				<th>Наименование подстанции потребителя</th>
		   				<th>Наименование присоединения потребителя</th>
		   				<th>Класс напряжения, кВ</th>
		   				<th>Комментарий</th>
		   				<th><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></th>
					</tr>	
				</thead>
				<tbody>
	   				<tr>
	   					<td><%= text_field_tag 'name', @mpoint.name, placeholder: "Точка учета..." %></td>		
						<td><%= text_field_tag 'messtation', @mpoint.messtation, placeholder: "Подстанция..." %></td>
						<td><%= text_field_tag 'meconname', @mpoint.meconname,  placeholder: "Фидер..." %></td>
						<td><%= text_field_tag 'clsstation', @mpoint.clsstation, placeholder: "Подстанция..." %></td>
						<td><%= text_field_tag 'clconname', @mpoint.clconname,  placeholder: "Фидер..." %></td>
						<td><%= number_field_tag 'voltcl', @mpoint.voltcl,  placeholder: "Класс напряжения", min: 0.1, max: 1000000, step: 0.1 %></td>
						<td><%= text_field_tag 'comment', @mpoint.comment, placeholder: 'Комментарий...' %></td>
						<td><%= check_box_tag 'f', 'yes', @mpoint.f %></td>			        
	   				</tr>
				</tbody>
			</table>
  			<%= hidden_field_tag :company_id, @mpoint.company.id %>
  			<%= hidden_field_tag :id, @mpoint.id %> 
  			<div  align="center">
				<%= button_tag "Сохранить", type: 'submit', class: "btn btn-default glyphicon glyphicon-ok pull-center", 
				                data: { confirm: "Сохранить данные для #{@cp.furnizor.name}, #{@cp.filial.name} / #{@cp.name}?" } %>
				<%= button_tag "Отмена", type: "submit", name: "cancel", value: true, class: "btn btn-default glyphicon glyphicon-remove pull-center" %>                
			</div> 
		<% end %>
      </div>
    </div>
  </div>  
</div>
	
<h2 align="center">Точки учета</h2> 
           
<table class="table table-striped  table-hover">
		<thead>
			<tr class="info">
			   <th>№</th>
			   <th>Наименование</th>
			   <th>Подстанция</th>
			   <th>Присоединение</th>
			   <th>Класс напряжения, кВ</th>
               <% if (current_user.has_role? :cduser) || (@fpr > 5) %> 
			      <th>Счетчики</th>
			      <th>Показания</th>
			   <% else %>
			      <th>Параметры</th>		   
			   <% end %>   
			   <th>Комментарий</th>
			   <th><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></th>
			   <th>.........</th>	   
			</tr>	
		</thead>
		<tbody>
			   <% i = 0%>
			   <% @mp.each do |item| %>
			   <% if item.updated_at > (Time.now.ago($GreenDelay)) %>
			    	<tr class="success">
			   <% else %> 	
					<tr>
			   <% end %>	
						<% i = i + 1 %>
						<td><%= if params[:page].nil? then i else (params[:page].to_i - 1) * @perpage + i end %></td>
						<td><%= item.name %></td>						
						<td><%= "#{item.messtation} / #{item.clsstation}" %></td>
						<td><%= "#{item.meconname} / #{item.clconname}" %></td>
						<td><%= item.voltcl %></td>
						<% if (current_user.has_role? :cduser) || (@fpr > 5) %> 
						   <td><%= link_to "Открыть" , meters_index_path(:id => item.id), :class=> "glyphicon glyphicon-folder-open" %></td>
  						   <td><%= link_to " " , mpoint_path(item), :class=> "glyphicon glyphicon-folder-open" %>
  						       <%= link_to image_tag('Excel-icon.png', :alt => "XLSX", :width => "20", :height => "20"), mpoint_path(item,format: "xlsx") %>
  						       <%= link_to image_tag('Apps-Pdf-B-icon.png', :alt => "PDF", :width => "20", :height => "20"), mpoint_path(item,format: "pdf") %></td>
  						<% else %>
  						   <td><%= link_to " " , mpoint_path(item), :class=> "glyphicon glyphicon-folder-open" %>
  						       <%= link_to image_tag('Excel-icon.png', :alt => "XLSX", :width => "20", :height => "20"), "#" %>
  						       <%= link_to image_tag('Apps-Pdf-B-icon.png', :alt => "PDF", :width => "20", :height => "20"), "#" %></td>  						
  						<% end %>    
  						<td><%= item.comment %></td>
  						<td><span class="glyphicon glyphicon-<%= if item.f then 'ok' else 'minus' end %>" aria-hidden="true"></span></td>      						
                        <td><%= link_to " " , mpoints_edit_path(:mp_id => item.id), :class=> "glyphicon glyphicon-pencil" %>
  						    <%= link_to " " , mpoints_destroy_path(:mp_id=>item.id), :class=> "glyphicon glyphicon-remove",
  						                 data: { confirm: "Удалить точку учета #{item.name} : #{item.messtation} / #{item.clsstation}, #{item.meconname} / #{item.clconname} ?" } %></td>
					</tr>		
				<% end %>			
		</tbody>
</table>

<center><small><%= if !@mp.nil? then will_paginate @mp, renderer: BootstrapPagination::Rails end %></small></center>

