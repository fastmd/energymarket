<% provide(:title, 'Точки учета') %>
	           
<nav class="navbar">
  <ul class="nav nav-pills pull-left">
    <li><%= link_to "Назад", companies_path(:id => @flr.id, :cp_id => @cp), :class => "glyphicon glyphicon-level-up" %></li>
  </ul>  
</nav>

<ul class="breadcrumb">
  <li><%= if (@fpr > 5) 
  	         then link_to "Поставщики", welcome_index_path, :class => "glyphicon glyphicon-home"
  	         else link_to "Филиалы", welcome_index_path, :class => "glyphicon glyphicon-home" end %></li>	
  <li><%= if (@fpr > 5) 
  	         then link_to(if @flr.name.upcase.include?("FEE") then "Поставщик: #{@flr.name} #{image_tag('fee.png', :size => 25)}".html_safe
  	                      elsif @flr.name.upcase.include?("FENOSA") then "Поставщик: #{@flr.name} #{image_tag('fenosa.png', :size => 25)}".html_safe
  	                      else "Поставщик: #{@flr.name}" end, companies_path(:id => @flr.id, :cp_id => @cp), :class => "glyphicon glyphicon-piggy-bank")
  	         else link_to "Филиал: #{@flr.name}", companies_path(:id => @flr.id, :cp_id => @cp), :class => "glyphicon glyphicon-tower" end %>
  </li>  
  <li class="active"><span class="glyphicon glyphicon-lamp" aria-hidden="true"></span><strong><%= "Потребитель: #{@cp.name}" %></strong></li>
</ul>

<div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
  <div class="panel panel-default">
    <div class="panel-heading" role="tab" id="headingOne">
      <h4 class="panel-title">
        <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="false" aria-controls="collapseOne" class = "glyphicon glyphicon-wrench">
          <% if @flag=='edit' then %>Редактировать точку учета<% else %>Добавить точку учета<% end %>          
        </a>
      </h4>
    </div>
    <div id="collapseOne" class="panel-collapse <%= if (@flag!='edit' && @flag!='add') then "collapse" end %>" role="tabpanel" aria-labelledby="headingOne">	
      <div class="panel-body">
		<h3 align="center"><% if @flag=='edit' then %>Редактирование точки учета<% else %>Ввод новой точки учета<% end %></h3>
		<%= form_for(@mpoint, html: { class: 'form-inline' }) do |f| %>
				<div class="form-group"> 
						<label for='cod' class="control-label">Код</label>
	   					<%= number_field_tag 'cod', @mpoint.cod, class: "form-control",  placeholder: "Код", min: 1, max: 1000000000, step: 1 %>
		        </div>
		        <div class="form-group">
						<label for='name'class="control-label">Наименование</label>	   					
	   					<%= text_field_tag 'name', @mpoint.name, class: "form-control",  :size=>"50", placeholder: "Точка учета..." %>
				</div>		
				<div class="form-group">		
						<label for='furnizor_id' class="control-label">Поставщик</label>					
						<%= select_tag "furnizor_id", options_for_select( @furns, if !@mpoint.furnizor_id.nil? then @mpoint.furnizor_id else nil end ), class: "form-control" %>
				</div>		
			    <div class="form-group">                   
		   				<label for='thesauru_id' class="control-label">Подстанция (МЕ)</label>						
	   		            <%= select_tag 'mesubstation_id', options_for_select( @sstations, if !@mpoint.mesubstation_id.nil? then @mpoint.mesubstation_id else nil end), include_blank: false, prompt: "Select something", class: "form-control" %>
	   		   	</div>		
		   		<div class="form-group">		
		   				<label for='meconname' class="control-label">Точка учета (МЕ)</label>          	
						<%= text_field_tag 'meconname', @mpoint.meconname,  placeholder: "Присоединение (запитан потребитель)",  :size=>"50", class: "form-control" %>
				</div>
		   		<div class="form-group">		
		   				<label for='clsstation' class="control-label">Объект (потребитель)</label>		
						<%= text_field_tag 'clsstation', @mpoint.clsstation, placeholder: "Объект установки учета",  :size=>"50", class: "form-control" %>
				</div>
				<div class="form-group">
		   				<label for='clconname' class="control-label">Точка учета (потребитель)</label>						
						<%= text_field_tag 'clconname', @mpoint.clconname,  placeholder: "Присоединение установки учета",  :size=>"50", class: "form-control" %>
				</div>
    		   	<div class="form-group">		   				
		   				<label for='voltcl' class="control-label">Класс напряжения, кВ</label>		
						<%= number_field_tag 'voltcl', @mpoint.voltcl,  placeholder: "Класс напряжения", min: 0.1, max: 1000000, step: 0.1, class: "form-control" %>
		   		</div>
		   		<div class="form-group">		
		   				<label for='comment' class="control-label">Комментарий</label>						
						<%= text_field_tag 'comment', @mpoint.comment, placeholder: 'Комментарий...',  :size=>"50", class: "form-control" %>
		   		</div>		
		   		<div class="form-group">		
		   				<label for='fct' class="control-label">Не считать тех.расход <%= image_tag('faract.png', :alt => "без СТ", :width => 35, :height => 25) %></label>						
						<%= check_box_tag 'fct', 'yes', @mpoint.fct, class: "form-control" %>
						<label for='fctc' class="control-label">Не считать емкостной тех расход <%= image_tag('c.png', :alt => "без СТ емк", :width => 35, :height => 25) %></label>						
						<%= check_box_tag 'fctc', 'yes', @mpoint.fctc, class: "form-control" %>
					    <label for='fctl' class="control-label">Не считать индуктивный тех расход <%= image_tag('l1.png', :alt => "без СТ инд", :width => 35, :height => 25) %></label>						
						<%= check_box_tag 'fctl', 'yes', @mpoint.fctl, class: "form-control" %>						
			    </div>
			    <div class="form-group">		   				
		   				<label for='cosfi' class="control-label">cos φ</label>		
						<%= number_field_tag 'cosfi', @mpoint.cosfi,  placeholder: "cos φ", min: 0, max: 1, step: 0.01, class: "form-control", :title => "cos φ" %>
		   		</div>
		   		<div class="form-group">		
		   				<label for='four' class="control-label">Наш трансформатор <span class="glyphicon glyphicon-flag" aria-hidden="true"></span></label>						
						<%= check_box_tag 'four', 'yes', @mpoint.four, class: "form-control" %>				
			    </div>
			    <div class="form-group">		
		   				<label for='fturn' class="control-label">Обратное включение счетчика <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span></label>						
						<%= check_box_tag 'fturn', 'yes', @mpoint.fturn, class: "form-control" %>				
			    </div>
		   		<div class="form-group">		
		   				<label for='f' class="control-label">Активный</label>						
						<%= check_box_tag 'f', true, @mpoint.f, class: "form-control" %>				
			    </div>		   		
	  			<%= hidden_field_tag :company_id, @mpoint.company.id %>
	  			<%= hidden_field_tag :id, @mpoint.id %>
	  			<%= hidden_field_tag :flr_id, @flr.id %> 
	  			<div  align="center">
					<%= button_tag "Сохранить", type: 'submit', class: "btn btn-default glyphicon glyphicon-ok pull-center", 
					                data: { confirm: "Сохранить данные для #{@flr.name} / #{@cp.name}?" } %>
					<%= button_tag "Отмена", type: "submit", name: "cancel", value: true, class: "btn btn-default glyphicon glyphicon-remove pull-center" %>                
				</div> 
		<% end %>
      </div>
    </div>
  </div>  
</div>
	
<h3 align="center">Точки учета <span class="glyphicon glyphicon-object-align-horizontal" aria-hidden="true"></span></h3> 
           
<table class="table table-striped  table-hover">
		<thead>
			<tr class="info">
			   <th>№</th>
			   <th>Код</th>
			   <th>Поставщик<span class="glyphicon glyphicon-piggy-bank" aria-hidden="true"></span></th>
			   <th>Филиал<span class="glyphicon glyphicon-tower" aria-hidden="true"></span></th>
			   <th>Район <%= image_tag('moldova-map.png', :alt => "Регионы", :width => 25, :height => 25) %></th>
			   <th>Подстанция (МЕ) <%= image_tag('consumator.png', :alt => "Подстанции", :width => 35, :height => 25) %></th>
			   <th>Точка учета (МЕ)</th>
			   <th>Точка учета (потребитель)</th>			   
			   <th>Uном, кВ</th> 
			   <th title="Особенности расчета тех расхода">Тех. расход</th>
			   <th title="Сos из контракта">cos φ</th>
			   <th title="Не считать потери хх в трансформаторе">Наш тр-р</th>
			   <th title="Обратное включение счетчика">Обр.сч.</th> 	
			   <th>Комментарий</th>
			   <th><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></th>
			   <% if (current_user.has_role? :cduser) || (@fpr > 5) %> 
			      <th>.....</th>
			      <th>.....</th>
			   <% else %>
			      <th>.....</th>
			      <th>.....</th>
			      <th>.....</th>		   
			   <% end %>  
			   <th>.....</th>	   
			</tr>	
		</thead>
		<tbody>
			   <% i = 0%>
			   <% @mp.each do |item| %>
			   <% if item.updated_at > (Time.now.ago($GreenDelay)) %>
			    	<tr class="success">
			   <% else %> 	
					<tr>
			   <% end %>	
						<% i = i + 1 %>
						<td><%= if params[:page].nil? then i else (params[:page].to_i - 1) * @perpage + i end %></td>
						<td><%= item.cod %></td>
						<td><%= if item.furnizor then item.furnizor.name end %></td>
						<td><%= if item.filial then item.filial.name end %></td>
						<td><%= if item.region then item.region.cvalue end %></td>
						<td><%= if item.mesubstation then item.mesubstation.name end %></td>						
						<td><%= item.meconname %></td>
						<td><%= item.clconname %></td>						
						<td><%= item.voltcl %></td> 
  						<td ><% if item.fct then %><%= image_tag('faract.png', :alt => "без СТ", :width => 30, :height => 20, :title => "Не считать тех расход") %><% end %>
                             <% if item.fctc then %><%= image_tag('c.png', :alt => "без СТ емк", :width => 30, :height => 20, :title => "Не считать емкостной тех расход") %><% end %>
							 <% if item.fctl then %><%= image_tag('l1.png', :alt => "без СТ инд", :width => 30, :height => 20, :title => "Не считать индуктивный тех расход") %><% end %></td>
  						<td title="Сos из контракта"><%= item.cosfi %></td>
  						<td title="Не считать потери хх в трансформаторе"><% if item.four then %><span class="glyphicon glyphicon-flag" aria-hidden="true"></span><% end %></td>
  						<td title="Обратное включение счетчика"><% if item.fturn then %><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span><% end %></td> 	
  						<td><%= item.comment %></td>
  						<td><span class="glyphicon glyphicon-<%= if item.f then 'ok' else 'minus' end %>" aria-hidden="true"></span></td>
						<% if (current_user.has_role? :cduser) || (@fpr > 5) %> 
						   <td><%= link_to image_tag('meter.png', :alt => "Счетчики", :width => 20, :height => 20) , meters_index_path(:id => item.id), :title => "Счетчики" %></td>
  						   <td><%= link_to image_tag('indicii.png', :alt => "Показания", :width => 30, :height => 20), mpoint_path(item), :title => "Показания счетчиков" %>
  						       <%= link_to image_tag('Excel-icon.png', :alt => "XLSX", :width => "20", :height => "20"), mpoint_path(item,format: "xlsx") %>
  						       <%= link_to image_tag('Apps-Pdf-B-icon.png', :alt => "PDF", :width => "20", :height => "20"), mpoint_path(item,format: "pdf") %></td>
  						<% else %>
  						   <td><%= link_to image_tag('tr-lep.png', :alt => "Параметры", :width => 30, :height => 20) , mpoint_path(item), :title => "Параметры трансформаторов и линий" %>
  						   <td><%= link_to image_tag('big_thumb.png', :alt => "Formula", :width => "30", :height => "20"), companies_onempreport_path(:id => @flr.id, :mp_id => item.id, :page => @page), :title => "Расчет потерь с расшифровкой" %></td>      						
                           <td><%= link_to image_tag('indicii.png', :alt => "Показания", :width => 30, :height => 20), mpoints_showmvalues_path(:id => item.id), :title => "Показания счетчиков" %>
  						       <%= link_to image_tag('Excel-icon.png', :alt => "XLSX", :width => "20", :height => "20"), mpoints_showmvalues_path(:id => item.id,format: "xlsx") %>
  						       <%= link_to image_tag('Apps-Pdf-B-icon.png', :alt => "PDF", :width => "20", :height => "20"), mpoints_showmvalues_path(:id => item.id,format: "pdf") %></td>
  						<% end %>     						
                        <td><%= link_to " " , mpoints_edit_path(:mp_id => item.id,:flr_id=>@flr.id), :class=> "glyphicon glyphicon-pencil", :title => "Редактировать" %>
  						    <%= link_to " " , mpoints_destroy_path(:mp_id=>item.id,:flr_id=>@flr.id), :class=> "glyphicon glyphicon-remove", :title => "Удалить",
  						                 data: { confirm: "Удалить точку учета #{item.name} ?" } %></td>
					</tr>		
				<% end %>			
		</tbody>
</table>

<center><small><%= if !@mp.nil? then will_paginate @mp, renderer: BootstrapPagination::Rails end %></small></center>

